input {
  http {
    # port => 8181
    port => "${LOGSTASH_PORT:8181}"
    type => "syslog"
    codec => json {

    }

  }
  stdin{}
}

filter {
  if [type] == "syslog" {
    mutate {
      remove_field => ["@timestamp","host"]
    }

    grok {
      match => { 
        "message" => [
      # Jul 23 16:37:44 192.168.1.236 Jul 23 16:37:44 splunk systemd[1]: plymouth-quit.service: Deactivated successfully.
         
          "%{SYSLOGTIMESTAMP:timestamp} %{SYSLOGHOST:host} %{SYSLOGTIMESTAMP} %{SYSLOGHOST:hostname} %{WORD:process}\[%{NUMBER:pid}\]: %{GREEDYDATA:log_message}",
          "%{SYSLOGTIMESTAMP:timestamp} %{IP:ip1} %{SYSLOGTIMESTAMP:timestamp2} %{SYSLOGHOST:hostname} %{WORD:process}: %{USER:user} : TTY=%{NOTSPACE:tty} ; PWD=%{PATH:pwd} ; USER=%{USER:sudo_user} ; COMMAND=%{GREEDYDATA:command}",
          "%{SYSLOGTIMESTAMP:timestamp} %{WORD:program} \(%{WORD:process}\): %{GREEDYDATA:log_message}",
          "%{GREEDYDATA:log_message}"
        ]
      }
    }

    if [log_message] {
      grok {
        match => {
          "log_message" => [
            "%{SYSLOGTIMESTAMP:timestamp} %{IP:ip1} %{SYSLOGTIMESTAMP:timestamp2} %{SYSLOGHOST:hostname} %{WORD:process}\[%{NUMBER:pid}\]: pam_unix\(%{WORD:service}:session\): session opened for user %{USER:user}\(uid=%{NUMBER:uid}\) by \(uid=%{NUMBER:by_uid}\)",
            "\(%{USER:user}\) %{CRON_ACTION:[system][cron][action]} \(%{DATA:[system][cron][command]}\)",
            "%{WORD:status} password for %{USER:user} from %{IP:source_ip} port %{NUMBER:destination_port} %{WORD:protocol}",
            "%{TIME:time} %{LOGLEVEL:loglevel}  %{DATA:component} - \(#%{NUMBER:attempt}\) %{GREEDYDATA:message_body}",
            "PAM %{NUMBER:failures_count} more authentication failures; logname=%{DATA:logname} uid=%{NUMBER:uid} euid=%{NUMBER:euid} tty=%{WORD:tty} ruser=%{DATA:ruser} rhost=%{IP:source_ip}  user=%{WORD:user}",
            "pam_unix\(%{WORD:service}:session\): session opened for user %{USER:user}\(uid=%{NUMBER:uid}\) by \(uid=%{NUMBER:by_uid}\)",
            "pam_unix\(%{WORD:service}:auth\): authentication failure; logname=%{DATA:logname} uid=%{NUMBER:uid} euid=%{NUMBER:euid} tty=%{WORD:tty} ruser= rhost=%{IP:source_ip}  user=%{USER:user}",
            "%{GREEDYDATA}"
            ]
        }
      }
    }
    mutate {
    lowercase => ["log_message"]
  }

  if "authentication failure" in [log_message] or "failed password" in [log_message] {
     mutate {
        add_field => { 
          "[event][type]" => "authentication_failed" 
          "[event][category]"=>"authentication"
          }
    }
  }
  else if "authentication success" in [log_message] or "accepted password" in [log_message] {
   mutate {
        add_field => { 
          "[event][type]" => "authentication_success"
          "[event][category]"=>"authentication"
        }
    }
  }
    mutate {
      remove_field => [
        "headers"
      # ,"message"
      ]
    }

    date {
      match => ["timestamp", "MMM dd HH:mm:ss","MMM  d HH:mm:ss"]
      target => "@timestamp"
      locale => "en"
    }
  }
}

output {  
  elasticsearch {
        # hosts => "http://192.168.1.103:9200"
        hosts=> "${ELASTIC_HOST:127.0.0.1:9200}"
        index => "%{index}"
  }
  # stdout{}
}

#Jul 23 13:23:00 192.168.1.30 Jul 23 18:23:00 ubuntu16 sudo: vboxuser : TTY=pts/26 ; PWD=/home/vboxuser ; USER=root ; COMMAND=/usr/bin/apt purge python3-pip
#%{SYSLOGTIMESTAMP:timestamp1} %{IP:ip1} %{SYSLOGTIMESTAMP:timestamp2} %{SYSLOGHOST:hostname} %{WORD:process}: %{WORD:auth_type}\(%{WORD:auth_mechanism}\): session %{WORD:session_state} for user %{USER:user} by %{USER:by_user}\(uid=%{NUMBER:uid}\)
  # "substring1" in [message] or "substring2" in [message]
   # "%{SYSLOGTIMESTAMP:timestamp} %{IP:host} %{SYSLOGTIMESTAMP} %{SYSLOGHOST:log_source} %{WORD:process}\[%{NUMBER:pid}\]: %{TIME:time} %{LOGLEVEL:loglevel}  %{DATA:component} - \(#%{NUMBER:attempt}\) %{GREEDYDATA:message_body}",
          # "%{SYSLOGTIMESTAMP:timestamp} %{SYSLOGHOST:host} %{SYSLOGTIMESTAMP:t2}%{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}",
# Jul 23 12:30:45 192.168.1.30 Jul 23 17:30:45 ubuntu16 sshd[13723]: PAM 4 more authentication failures; logname= uid=0 euid=0 tty=ssh ruser=someuser rhost=192.168.1.39  user=vboxuser
